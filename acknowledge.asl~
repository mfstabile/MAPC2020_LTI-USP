+thing(0,0,entity,_,T) <- true.

+thing(X,Y,entity,TEAM,T) : not position(me,_,_,T) & team(TEAM) <- 
	.wait("+position(me,_,_,T)");
	?position(me,XM,YM,T);
	.my_name(M);
	?stepLog(Step,T);
	+entity(X,Y,Step);
	.broadcast(tell,acknowledge(M,X,Y,XM,YM,Step)).

+thing(X,Y,entity,TEAM,T) : position(me,XM,YM,T) & team(TEAM) <- 
	.my_name(M);
	?stepLog(Step,T);
	+entity(X,Y,Step);
	.broadcast(tell,acknowledge(M,X,Y,XM,YM,Step)).
	
+stepLog(STEP,_): stepLog(STEP-3,TIME) & acknowledge(_,_,_,_,_,Step-3) & entity(_,_,Step-3) <- 
TIME=STEP-3;
for ( entity(XE,YE,TIME) ) {
	.setof(acknowledge(M,-XE,-YE,XMg,YMg,TIME),acknowledge(M,-XE,-YE,XMg,YMg,TIME),Acks);
	if (.length(Acks,1)){
		.nth(0,Acks,acknowledge(M,_,_,XA,YA,TIME));
		if(.count(mapper(M,_,_),0)){
			?logposition(me,XM,YM,TIME);
			+mapper(M,XA-(XM+XE),YA-(YM+YE));
			X1 = XA-(XM+XE);
			Y1 = YA-(YM+YE);
			.count(mapper(_,_,_,_,_,_),Mapps);
			-recognized(_);
			+recognized(Mapps);
			for ( thing(XD,YD,dispenser,B) ) {
				.send(M,tell,thing(XD+X1,YD+Y1,dispenser,B));
			}
			for ( thing(XT,YT,taskboard) ) {
				.send(M,tell,thing(XT+X1,YT+Y1,taskboard));
			}
			for ( goal(XG,YG) ) {
				.send(M,tell,goal(XG+X1,YG+Y1));
			}
		}
	}
}.
